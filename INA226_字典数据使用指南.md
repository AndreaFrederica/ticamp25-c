# INA226 字典格式计量数据使用指南

## 功能概述

INA226类现在提供了多种获取字典格式计量数据的方法，方便不同场景下的数据获取和处理。

## 主要功能函数

### 1. `get_all_measurements()` - 基本测量数据
返回包含所有基本测量值的字典。

```python
ina = INA226()
data = ina.get_all_measurements()
# 返回格式:
{
    'shunt_voltage_mv': 2.5,      # 分流电压 (mV)
    'bus_voltage_v': 12.0,        # 总线电压 (V)
    'current_a': 0.25,            # 电流 (A)
    'power_w': 3.0                # 功率 (W)
}
```

### 2. `get_measurements_with_units()` - 带单位信息的测量数据
返回包含测量值、单位和设备信息的详细字典。

```python
data = ina.get_measurements_with_units()
# 返回格式:
{
    'timestamp': 1690000000.0,
    'measurements': {
        'shunt_voltage': {'value': 2.5, 'unit': 'mV'},
        'bus_voltage': {'value': 12.0, 'unit': 'V'},
        'current': {'value': 0.25, 'unit': 'A'},
        'current_ma': {'value': 250.0, 'unit': 'mA'},
        'power': {'value': 3.0, 'unit': 'W'},
        'power_mw': {'value': 3000.0, 'unit': 'mW'}
    },
    'device_info': {
        'address': '0x40',
        'shunt_ohms': 0.01,
        'max_expected_amps': 5.0,
        'current_lsb': 0.0001525,
        'power_lsb': 0.003815
    }
}
```

### 3. `get_formatted_measurements()` - 格式化的测量数据
返回便于显示的格式化字符串数据。

```python
data = ina.get_formatted_measurements()
# 返回格式:
{
    'shunt_voltage': '2.500 mV',
    'bus_voltage': '12.000 V',
    'current': '250.000 mA',
    'power': '3000.000 mW',
    'timestamp': '2024-08-02 10:30:45'
}
```

### 4. `get_summary_dict()` - 摘要数据
返回包含基本测量值和计算值的摘要信息。

```python
data = ina.get_summary_dict()
# 返回格式:
{
    'basic_measurements': { /* 基本测量数据 */ },
    'calculated_values': {
        'load_resistance_ohms': 48.0,           # 负载电阻
        'power_efficiency_percent': 98.5,       # 功率效率
        'energy_1h_wh': 3.0,                   # 1小时能耗
        'energy_24h_wh': 72.0                  # 24小时能耗
    },
    'status': {
        'is_consuming_power': True,             # 是否在消耗功率
        'is_high_current': False,               # 是否高电流
        'measurement_time': '2024-08-02 10:30:45',
        'uptime_seconds': 300.5                 # 设备运行时间
    }
}
```

### 5. `get_monitoring_data(samples, interval)` - 监控数据
进行多次采样并返回统计信息。

```python
data = ina.get_monitoring_data(samples=10, interval=0.1)
# 返回格式:
{
    'sample_info': {
        'samples': 10,
        'interval_seconds': 0.1,
        'total_time_seconds': 0.9
    },
    'statistics': {
        'current': {
            'min_a': 0.24, 'max_a': 0.26, 'avg_a': 0.25,
            'min_ma': 240.0, 'max_ma': 260.0, 'avg_ma': 250.0
        },
        'voltage': {
            'min_v': 11.9, 'max_v': 12.1, 'avg_v': 12.0
        },
        'power': {
            'min_w': 2.8, 'max_w': 3.1, 'avg_w': 3.0,
            'min_mw': 2800.0, 'max_mw': 3100.0, 'avg_mw': 3000.0
        }
    },
    'raw_data': [ /* 所有原始测量数据 */ ]
}
```

## 使用示例

### 基本使用
```python
from ina226 import INA226

# 初始化传感器
ina = INA226(i2c_bus=1, address=0x40, shunt_ohms=0.01, max_expected_amps=5.0)

# 获取基本数据
basic_data = ina.get_all_measurements()
print(f"当前电流: {basic_data['current_a']*1000:.1f} mA")

# 获取格式化数据
formatted_data = ina.get_formatted_measurements()
print(f"电流: {formatted_data['current']}")

# 关闭连接
ina.close()
```

### 数据记录
```python
import json
import time

ina = INA226()

# 记录详细数据
data = ina.get_measurements_with_units()
filename = f"measurement_{int(time.time())}.json"
with open(filename, 'w') as f:
    json.dump(data, f, indent=2)

# 记录监控数据
monitoring_data = ina.get_monitoring_data(samples=60, interval=1.0)  # 1分钟数据
with open('monitoring.json', 'w') as f:
    json.dump(monitoring_data, f, indent=2)
```

### 连续监控
```python
import time

ina = INA226()

try:
    while True:
        summary = ina.get_summary_dict()
        
        # 检查状态
        if summary['status']['is_high_current']:
            print("警告: 电流过高!")
        
        # 显示当前数据
        measurements = summary['basic_measurements']
        print(f"功率: {measurements['power_w']*1000:.1f} mW")
        
        time.sleep(1)
        
except KeyboardInterrupt:
    print("监控停止")
finally:
    ina.close()
```

## 测试程序

运行测试程序来查看所有功能：

```bash
# 运行所有测试
python ina226_test.py

# 连续监控模式
python ina226_test.py monitor

# 数据保存测试
python ina226_test.py save
```

## 注意事项

1. 所有时间戳都使用Unix时间戳格式
2. 电流和功率的符号表示方向（正值表示消耗，负值表示产生）
3. 监控数据函数会阻塞执行，采样时间 = (samples-1) × interval
4. 使用完毕后记得调用 `close()` 方法关闭I2C连接
5. 确保I2C设备地址和分流电阻值配置正确
